{"version":3,"sources":["../../webapp/renderOnServer.js"],"names":["serveFailure","require","load","isoVars","JSON","stringify","httpError500FileName","resolve","__dirname","httpError404FileName","type","res","message","err","log","status","sendFile","req","next","assetsPath","routes","location","originalUrl","error","redirectLocation","renderProps","redirect","pathname","search","reunderOnServerCorrectRequest","objectManager","then","codeFoundriesInjected","user","getOneObject","id","getViewerUserId","networkLayer","NetworkLayer","schema","rootValue","onError","errors","request","render","data","props","global","navigator","userAgent","headers","md","innerWidth","phone","tablet","window","isomorphicResponse","reactOutput","renderToString","helmet","rewind","preloadedData","replace","title","meta","link","backgroundColor","palette","backCanvas","viewportBackgroundColor","isomorphicVars","NODE_ENV","process","env","prepareData","catch"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiCgBA,Y,CAAAA,Y,CA/BhB,yC,uDACA,8D,2EACA,2C,yDACA,0B,yCACA,4B,2CACA,wC,6CACA,oD,iEACA,yCAEA,+DACA,8E,6DACA,kC,uCACA,uD,2DACA,0D,iDACA,sD,6CACA,yC,6CACA,6C,kIAIAC,QAAS,QAAT,EAAoBC,IAApB,GAIA,GAAMC,SAAUC,KAAKC,SAAL,CAAgB,8BAAhB,CAAhB,CAGA,GAAMC,sBAAuB,eAAKC,OAAL,CAAcC,SAAd,CAAyB,4CAAzB,CAA7B,CACA,GAAMC,sBAAuB,eAAKF,OAAL,CAAcC,SAAd,CAAyB,4CAAzB,CAA7B,CAGO,QAASR,aAAT,CAAuBU,IAAvB,CAA6BC,GAA7B,CAAkCC,OAAlC,CAA2CC,GAA3C,CAAiD;AACtD,cAAIC,GAAJ,CAASJ,IAAT,CAAe,iBAAmBE,OAAlC,CAA2CC,GAA3C;AACAF,IAAII,MAAJ,CAAY,GAAZ,EAAkBC,QAAlB,CAA4BV,oBAA5B;AACD,C;;AAEa,SAAEW,GAAF,CAAON,GAAP,CAAYO,IAAZ,CAAkBC,UAAlB,CAAkC;AAC9C,uBAAO,CAAEC,uBAAF,CAAUC,SAAUJ,IAAIK,WAAxB,CAAP,CAA8C,SAAEC,KAAF,CAASC,gBAAT,CAA2BC,WAA3B,CAA4C;AACxF,GAAIF,KAAJ;AACEL,KAAMK,KAAN,EADF;AAEK,GAAIC,gBAAJ;AACHb,IAAIe,QAAJ,CAAc,GAAd,CAAmBF,iBAAiBG,QAAjB,CAA4BH,iBAAiBI,MAAhE,EADG;AAEA,GAAIH,WAAJ;AACHI,8BAA+BZ,GAA/B,CAAoCN,GAApC,CAAyCO,IAAzC,CAA+CC,UAA/C,CAA2DM,WAA3D,EADG;;AAGHd,IAAII,MAAJ,CAAY,GAAZ,EAAkBC,QAAlB,CAA4BP,oBAA5B;AACH,CATD;AAUD,C;;AAED,QAASoB,8BAAT,CAAwCZ,GAAxC,CAA6CN,GAA7C,CAAkDO,IAAlD,CAAwDC,UAAxD,CAAoEM,WAApE,CAAkF;;AAEhF,GAAMK,eAAgB,6BAAtB;;AAEA,sCAAiBA,aAAjB,CAAgCb,GAAhC,CAAqCN,GAArC;AACGoB,IADH,CACS,UAAM,CAAEpB,IAAIqB,qBAAJ,CAA4B,CAAEC,KAAMH,cAAcI,YAAd,CAA4B,MAA5B,CAAoC,CAAEC,GAAIL,cAAcM,eAAd,EAAN,CAApC,CAAR,CAA5B,CAAqH,CADtI;AAEGL,IAFH,CAES,UAAM;AACX,GAAI;AACF,GAAMM,cAAe,GAAI,4BAAiBC,YAArB,CAAmC;AACtDC,uBADsD;AAEtDC,UAAWV,aAF2C;AAGtDW,QAAS,iBAAEC,MAAF,CAAUC,OAAV,QAAuB3C,cAAc,OAAd,CAAuBW,GAAvB,CAA4B,qCAA5B,CAAmE,CAAE+B,aAAF,CAAUC,eAAV,CAAnE,CAAvB,EAH6C,CAAnC,CAArB;;;AAMA,QAASC,OAAT,MAAmC,IAAhBC,KAAgB,MAAhBA,IAAgB,CAAVC,KAAU,MAAVA,KAAU;AACjC,GAAI;;;AAGFC,OAAOC,SAAP,CAAmB,CAAEC,UAAWhC,IAAIiC,OAAJ,CAAa,YAAb,CAAb,CAAnB;;;AAGA,GAAMC,IAAK,2BAAkBlC,IAAIiC,OAAJ,CAAa,YAAb,CAAlB,CAAX;;AAEA,GAAIE,kBAAJ;AACA,GAAID,GAAGE,KAAH,EAAJ;AACED,WAAa,GAAb,CADF;AAEK,GAAID,GAAGG,MAAH,EAAJ;AACHF,WAAa,GAAb,CADG;;AAGHA,WAAa,IAAb;;;AAGFL,OAAOQ,MAAP,CAAgB,CAAEH,WAAYA,UAAd,CAAhB;;;AAGAL,OAAO1B,QAAP,CAAkB,CAAEM,SAAUV,IAAIK,WAAhB,CAAlB;;;AAGA,GAAMkC,oBAAqB,gCAAiBZ,MAAjB,CAAyBE,KAAzB,CAA3B;AACA,GAAMW,aAAc,iBAAeC,cAAf;AAClB;AACE,WAAaN,UADf;;AAGII,kBAHJ,CADkB,CAApB;;;AAOA,GAAMG,QAAS,sBAAOC,MAAP,EAAf;;AAEAjD,IAAIiC,MAAJ,CAAY,eAAKrC,OAAL,CAAcC,SAAd,CAAyB,oBAAzB,CAAZ,CAA6D;AAC3DqD,cAAezD,KAAKC,SAAL,CAAgBwC,IAAhB,EAAuBiB,OAAvB,CAAgC,KAAhC,CAAuC,KAAvC,CAD4C;AAE3D3C,WAAYA,UAF+C;AAG3DsC,uBAH2D;AAI3DM,MAAOJ,OAAOI,KAJ6C;AAK3DC,KAAML,OAAOK,IAL8C;AAM3DC,KAAMN,OAAOM,IAN8C;AAO3DC,gBAAiB,mBAASC,OAAT,CAAiBC,UAAjB,CAA4BC,uBAPc;AAQ3DC,eAAgBnE,OAR2C;AAS3DoE,SAAUC,QAAQC,GAAR,CAAYF,QATqC,CAA7D;;AAWD,CAAC,MAAO1D,GAAP,CAAa;AACbb,aAAc,OAAd,CAAuBW,GAAvB,CAA4B,sCAA5B,CAAoEE,GAApE;AACD;AACF;;AAED,gCAAiB6D,WAAjB,CAA8BjD,WAA9B,CAA2CY,YAA3C,EAA0DN,IAA1D,CAAgEa,MAAhE,CAAwE1B,IAAxE;AACD,CAAC,MAAOL,GAAP,CAAa;AACbb,aAAc,OAAd,CAAuBW,GAAvB,CAA4B,uBAA5B,CAAqDE,GAArD;AACD;AACF,CAhEH;AAiEG8D,KAjEH,CAiEU,SAAEpD,KAAF,QAAa,gDAA2BN,GAA3B,CAAgCN,GAAhC,CAAqCY,KAArC,CAA4C,KAA5C,CAAb,EAjEV;AAkED","file":"renderOnServer.js","sourcesContent":["// @flow weak\n\nimport Helmet from 'react-helmet'\nimport IsomorphicRouter from 'isomorphic-relay-router'\nimport MobileDetect from 'mobile-detect'\nimport path from 'path'\nimport React from 'react'\nimport ReactDOMServer from 'react-dom/server'\nimport RelayLocalSchema from 'relay-local-schema'\nimport { match } from 'react-router'\n\nimport { getUserByCookie, serveAuthenticationFailed } from '../server/checkCredentials.js'\nimport isomorphicVars from '../configuration/webapp/scripts/isomorphicVars'\nimport log from '../server/log'\nimport ObjectManager from '../graphql/ObjectManager'\nimport muiTheme from '../configuration/webapp/muiTheme'\nimport routes from '../configuration/webapp/routes'\nimport schema from '../graphql/schema' // Schema for GraphQL server\nimport Wrapper from './components/Wrapper'\n\n\n// Read environment\nrequire( 'dotenv' ).load()\n\n\n// Load up isomorphic vars here, for server rendering\nconst isoVars = JSON.stringify( isomorphicVars() )\n\n\nconst httpError500FileName = path.resolve( __dirname, '../configuration/server/httpError/500.html' )\nconst httpError404FileName = path.resolve( __dirname, '../configuration/server/httpError/404.html' )\n\n\nexport function serveFailure( type, res, message, err ) {\n  log.log( type, 'Server error: ' + message, err )\n  res.status( 500 ).sendFile( httpError500FileName )\n}\n\nexport default( req, res, next, assetsPath ) => {\n  match( { routes, location: req.originalUrl }, ( error, redirectLocation, renderProps ) => {\n    if( error )\n      next( error )\n    else if( redirectLocation )\n      res.redirect( 302, redirectLocation.pathname + redirectLocation.search )\n    else if( renderProps )\n      reunderOnServerCorrectRequest( req, res, next, assetsPath, renderProps )\n    else\n      res.status( 404 ).sendFile( httpError404FileName )\n  } )\n}\n\nfunction reunderOnServerCorrectRequest( req, res, next, assetsPath, renderProps ) {\n  // create individual object manager for each request\n  const objectManager = new ObjectManager()\n\n  getUserByCookie( objectManager, req, res )\n    .then( () => { res.codeFoundriesInjected = { user: objectManager.getOneObject( 'User', { id: objectManager.getViewerUserId() } ) } } )\n    .then( () => {\n      try {\n        const networkLayer = new RelayLocalSchema.NetworkLayer( {\n          schema,\n          rootValue: objectManager,\n          onError: ( errors, request ) => serveFailure( 'error', res, 'local network layer GraphQL failure', { errors, request } )\n        } )\n\n        function render( { data, props } ) {\n          try {\n            // Setting up static, global navigator object to pass user agent to material-ui. Since the function is synchronous,\n            // it is OK to do so.\n            global.navigator = { userAgent: req.headers[ 'user-agent' ] }\n\n            // Also, set width to emulate phone, tablet or desktop\n            const md = new MobileDetect( req.headers[ 'user-agent' ] )\n\n            let innerWidth\n            if( md.phone() )\n              innerWidth = 700 // Will qualify as SMALL\n            else if( md.tablet() )\n              innerWidth = 900 // Will qualify as MEDIUM\n            else\n              innerWidth = 1100 // Will qualify as LARGE\n\n            // TODO x0100 This should be removed, won't work in multi-request situation anyway\n            global.window = { innerWidth: innerWidth }\n\n            // Also set global location for the leftNav\n            global.location = { pathname: req.originalUrl }\n\n            // Get the react output HTML\n            const isomorphicResponse = IsomorphicRouter.render( props )\n            const reactOutput = ReactDOMServer.renderToString(\n              <Wrapper\n                innerWidth={ innerWidth }\n              >\n                { isomorphicResponse }\n              </Wrapper>\n            )\n            const helmet = Helmet.rewind()\n\n            res.render( path.resolve( __dirname, 'renderOnServer.ejs' ), {\n              preloadedData: JSON.stringify( data ).replace( /\\//g, '\\\\/' ),\n              assetsPath: assetsPath,\n              reactOutput,\n              title: helmet.title,\n              meta: helmet.meta,\n              link: helmet.link,\n              backgroundColor: muiTheme.palette.backCanvas.viewportBackgroundColor,\n              isomorphicVars: isoVars,\n              NODE_ENV: process.env.NODE_ENV,\n            } )\n          } catch( err ) {\n            serveFailure( 'error', res, 'renderOnServer render funcion failed', err )\n          }\n        }\n\n        IsomorphicRouter.prepareData( renderProps, networkLayer ).then( render, next )\n      } catch( err ) {\n        serveFailure( 'error', res, 'renderOnServer failed', err )\n      }\n    } )\n    .catch( ( error ) => serveAuthenticationFailed( req, res, error, false ) )\n}\n"]}